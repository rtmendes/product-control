// Product Control - Multi-Brand Schema (Single User Mode)
// Optimized for multiple brands without authentication

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// BRANDS (Multiple brands supported)
// ============================================

model Brand {
  id                    String   @id @default(cuid())

  // Brand Identity
  brandName             String
  tagline               String?
  avatar                String?  @db.Text
  logoUrl               String?

  // Colors
  primaryColor          String   @default("#3B82F6")
  secondaryColor        String   @default("#10B981")
  accentColor           String   @default("#F59E0B")

  // Typography
  fontFamily            String   @default("Inter")
  headingFont           String?
  bodyFont              String?

  // Voice & Positioning
  voiceTone             String?  @db.Text
  targetAudience        String?  @db.Text
  uniqueSellingProp     String?  @db.Text

  // Research
  competitorUrls        Json?
  sampleProducts        Json?
  designAssets          Json?

  // Status
  isActive              Boolean  @default(true)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  products              Product[]
  knowledgeBase         KnowledgeBaseEntry[]
  assets                Asset[]
  campaigns             Campaign[]
  revenueGoals          RevenueGoal[]

  @@index([isActive])
}

// ============================================
// PRODUCTS
// ============================================

model Product {
  id                String   @id @default(cuid())
  brandId           String
  shopifyId         String?  @unique

  // Product Type & Status
  type              String
  status            String   @default("draft")

  // Basic Info
  title             String
  description       String?  @db.Text
  handle            String?

  // Variants & Pricing
  variants          Json?
  pricing           Json?
  compareAtPrice    Float?

  // POD Specific
  mockupUrls        Json?
  printProvider     String?
  productionCost    Float?

  // Performance Metrics
  revenue           Float    @default(0)
  orders            Int      @default(0)
  views             Int      @default(0)
  conversionRate    Float    @default(0)
  avgOrderValue     Float    @default(0)
  profitMargin      Float    @default(0)

  // SEO & Content
  seoKeywords       Json?
  metaTitle         String?
  metaDescription   String?  @db.Text
  blogContent       String?  @db.Text
  faqContent        Json?

  // Shopify Integration
  shopifyData       Json?
  themeMetafields   Json?

  // AI Generation
  generationContext Json?
  qualityScore      Float?
  aiGeneratedAt     DateTime?

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  publishedAt       DateTime?

  // Relations
  brand             Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  rules             ConditionalRule[]
  assets            Asset[]
  campaigns         Campaign[]

  @@index([brandId, type])
  @@index([shopifyId])
  @@index([status])
}

// ============================================
// CONDITIONAL LOGIC RULES
// ============================================

model ConditionalRule {
  id                String   @id @default(cuid())
  productId         String?

  name              String
  description       String?  @db.Text
  trigger           Json
  conditions        Json
  actions           Json
  schedule          Json?

  isActive          Boolean  @default(true)
  priority          Int      @default(0)
  executionCount    Int      @default(0)
  lastExecutedAt    DateTime?

  successRate       Float?
  avgExecutionTime  Int?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  product           Product? @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([isActive])
  @@index([productId])
}

// ============================================
// ASSETS (AI-GENERATED)
// ============================================

model Asset {
  id                String   @id @default(cuid())
  brandId           String
  productId         String?

  type              String
  subtype           String?

  title             String?
  description       String?  @db.Text
  content           String?  @db.Text
  url               String?  @db.Text
  thumbnailUrl      String?

  fileSize          Int?
  dimensions        Json?
  duration          Int?
  format            String?

  aiModel           String?
  prompt            String?  @db.Text
  generationParams  Json?
  qualityScore      Float?

  tags              Json?
  eagleId           String?
  airtableId        String?
  s3Key             String?

  usage             Int      @default(0)
  performance       Json?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  brand             Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  product           Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([brandId, type])
  @@index([productId])
  @@index([eagleId])
  @@index([airtableId])
}

// ============================================
// CAMPAIGNS
// ============================================

model Campaign {
  id                String   @id @default(cuid())
  brandId           String
  productId         String?

  name              String
  type              String
  platform          String?
  status            String   @default("draft")

  targeting         Json?
  budget            Float?
  schedule          Json?

  variants          Json?

  impressions       Int      @default(0)
  clicks            Int      @default(0)
  conversions       Int      @default(0)
  revenue           Float    @default(0)
  spend             Float    @default(0)
  roas              Float?

  klaviyoFlowId     String?
  facebookCampaignId String?
  googleCampaignId  String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  launchedAt        DateTime?
  completedAt       DateTime?

  brand             Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  product           Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([brandId, status])
  @@index([productId])
}

// ============================================
// REVENUE & GOALS
// ============================================

model RevenueGoal {
  id                String   @id @default(cuid())
  brandId           String

  name              String
  description       String?  @db.Text
  targetAmount      Float
  currentAmount     Float    @default(0)
  deadline          DateTime
  productIds        Json?
  status            String   @default("active")

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  brand             Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId, status])
}

// ============================================
// INTEGRATIONS (Global)
// ============================================

model Integration {
  id                String   @id @default(cuid())
  platform          String   @unique

  credentials       Json
  configuration     Json?

  status            String   @default("disconnected")
  lastSyncAt        DateTime?
  syncFrequency     String?
  syncErrors        Json?

  displayName       String?
  iconUrl           String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([status])
}

// ============================================
// ACTIVITY LOGS
// ============================================

model ActivityLog {
  id                String   @id @default(cuid())

  action            String
  entityType        String?
  entityId          String?

  metadata          Json?
  ipAddress         String?
  userAgent         String?  @db.Text

  agentName         String?
  executionTime     Int?

  createdAt         DateTime @default(now())

  @@index([createdAt])
  @@index([entityType, entityId])
  @@index([agentName])
}

// ============================================
// KNOWLEDGE BASE (Per Brand)
// ============================================

model KnowledgeBaseEntry {
  id                String   @id @default(cuid())
  brandId           String

  type              String
  category          String?

  title             String
  content           Json
  metadata          Json?

  tags              Json?
  relatedIds        Json?

  usageCount        Int      @default(0)
  effectivenessScore Float?

  version           Int      @default(1)
  previousVersionId String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  brand             Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId, type, category])
}
